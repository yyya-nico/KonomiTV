import{aC as v}from"./SnackbarsStore-DIk21UOt.js";import{m as b}from"./mpegts-18wrdV8K.js";const g=document.getElementById("wrap"),f=document.getElementById("chlist"),h=document.getElementById("control"),d=document.getElementById("volumebutton"),y=document.getElementById("keepshowsw"),u=document.getElementById("fsbutton"),_=()=>{let e=0,i=0;const n=()=>{clearTimeout(e),clearTimeout(i),g.classList.remove("hide-ui"),g.classList.remove("hide-info"),e=setTimeout(()=>{g.classList.add("hide-ui"),!y.checked&&(i=setTimeout(()=>{g.classList.add("hide-info")},3e3))},3e3)};window.addEventListener("pointerdown",n),window.addEventListener("pointermove",n),window.addEventListener("scroll",n),y.addEventListener("change",n),window.addEventListener("keydown",s=>{switch(s.key){case"A":case"a":d.click();break;case"F":case"f":u.click();break;case"ArrowUp":m(-3);break;case"ArrowLeft":m(-1);break;case"ArrowRight":m(1);break;case"ArrowDown":m(3);break}n()}),d.addEventListener("click",()=>m("toggle-all")),window.addEventListener("scroll",()=>{function s(){const a=window.document.body,l=window.document.documentElement,t=a.scrollTop||l.scrollTop;return l.scrollHeight-window.innerHeight-t}s()<=10?h.classList.add("slide"):h.classList.remove("slide")}),n()},w=async()=>{E=await fetch(`${v.getApiBaseUrl()}/channels`).then(e=>(e.status!==200&&console.log("error or no content",e.status),e.json())).catch(e=>(console.error("Failed to load",e),null))},T=()=>E?.GR,L=()=>T().filter(e=>e.is_display===!0);let E;await w();const p=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),m=e=>{const i=r.filter(t=>!t.video.muted),n=i.length===0,s=i.length===r.length,a=Array(r.length).fill(!0);if(e==="all")a.fill(!1);else if(e==="toggle-all")s||a.fill(!1);else if(typeof e=="number")if(n)a[0]=!1;else{let c=(i[0].index+e)%r.length;c<0&&(c=r.length+c),a[c]=!1}else if(typeof e=="object"){const t=e;(s||t.video.muted)&&(a[t.index]=!1)}r.forEach((t,o)=>{t.video.muted=a[o]}),r.filter(t=>!t.video.muted).length===1?f.classList.add("choiced"):f.classList.remove("choiced")},r=[];L().forEach((e,i)=>{const n=`<div class="chframe">
        <video playsinline controlsList="noremoteplayback"></video>
        <div class="broadcast-wrap">
            <div class="broadcast-channel-box">
                <span class="broadcast-channel">${e.remocon_id}</span>
                <img class="broadcast-logo" src="${v.getApiBaseUrl()}/channels/${e.id}/logo" alt="${e.name}">
            </div>
            <div class="broadcast-title">
                <span class="broadcast-title-id">${e.program_present?.title??"(情報なし)"}</span>
                <div class="broadcast-time">
                    <span class="broadcast-start">${e.program_present?p(e.program_present.start_time):"--:--"}</span>
                    <span class="broadcast-to">～</span>
                    <span class="broadcast-end">${e.program_present?p(e.program_present.end_time):"--:--"}</span>
                </div>
            </div>
        </div>
        <div class="control">
            <button type="button" class="reload btn" title="再読み込み"><i class="material-icons">refresh</i></button>
        </div>
    </div>
    `;f.insertAdjacentHTML("beforeend",n);const s=f.lastElementChild,a={chFrame:s,index:i,video:s.querySelector("video"),reloadButton:s.querySelector(".reload"),broadcastTitle:s.querySelector(".broadcast-title"),title:s.querySelector(".broadcast-title-id"),startTime:s.querySelector(".broadcast-start"),endTime:s.querySelector(".broadcast-end")};if(r.push(a),s.addEventListener("click",()=>m(a)),a.video.addEventListener("volumechange",l=>{l.target.muted?s.classList.remove("listening"):s.classList.add("listening");const t=r.some(c=>!c.video.muted),o=r.every(c=>!c.video.muted);t?(d.innerHTML='<i class="material-icons">volume_up</i>',o?d.title="ミュートする":d.title="全ch聴く"):(d.innerHTML='<i class="material-icons">volume_off</i>',d.title="全ch聴く")}),b.getFeatureList().mseLivePlayback){const l=`${v.getApiBaseUrl()}/streams/live/${e.display_channel_id}/360p/mpegts`,t=b.createPlayer({type:"mse",isLive:!0,url:l});t.attachMediaElement(a.video),a.reloadButton.addEventListener("click",o=>{if(o.stopPropagation(),t.unload(),o.shiftKey){alert("Shiftキーを押しながらクリックしたため、読み込み停止をしました。");return}t.load(),t.play()}),t.load(),t.play().then(()=>{m("all")}).catch(()=>{t.muted=!0,t.play()})}});_();setInterval(async()=>{await w(),L().forEach((e,i)=>{const n=r[i],s={title:n.title,startTime:n.startTime,endTime:n.endTime},a=Object.values(s).map(o=>o.textContent),l=[e.program_present?.title??"(情報なし)",e.program_present?p(e.program_present.start_time):"--:--",e.program_present?p(e.program_present.end_time):"--:--"];if(a.toString()!==l.toString()){const o=`<span class="broadcast-title-id">${e.program_present?.title??"(情報なし)"}</span>
                <div class="broadcast-time">
                    <span class="broadcast-start">${e.program_present?p(e.program_present.start_time):"--:--"}</span>
                    <span class="broadcast-to">～</span>
                    <span class="broadcast-end">${e.program_present?p(e.program_present.end_time):"--:--"}</span>
                </div>
            </div>`;n.broadcastTitle.innerHTML=o}})},30*1e3);u.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(e=>{alert("ご利用のブラウザは全画面表示に対応していません"+e.name)})});const k=()=>{document.fullscreenElement?(screen.orientation.lock("landscape").catch(()=>{}),u.innerHTML='<i class="material-icons">fullscreen_exit</i>',u.title="全画面表示を終了"):(screen.orientation.unlock&&screen.orientation.unlock(),u.innerHTML='<i class="material-icons">fullscreen</i>',u.title="全画面表示")};document.addEventListener("fullscreenchange",k);
