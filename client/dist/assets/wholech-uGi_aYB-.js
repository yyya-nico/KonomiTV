import{aD as u}from"./SnackbarsStore-BWrzfOQC.js";import{m as w}from"./mpegts-DuuhU9Ut.js";class p{static CHOICED_TILE=[[-1,-1,-1,6],[-1,-1,-1,5],[-1,-1,-1,4],[0,1,2,3],[7,8,9,10]];wrap;chList;control;volumeBtn;keepDisplaySw;fullscreenBtn;hideTimer;delayHideTimer;onVolumeClick;onTuning;constructor(e,t,s,n,i,r){this.wrap=e,this.chList=t,this.control=s,this.volumeBtn=n,this.keepDisplaySw=i,this.fullscreenBtn=r,this.hideTimer=null,this.delayHideTimer=null,this.onVolumeClick=()=>{},this.onTuning=()=>{}}init(){this.setupEventListeners(),this.showAndHide()}setupEventListeners(){const e=()=>this.showAndHide();window.addEventListener("pointerdown",e),window.addEventListener("pointermove",e),window.addEventListener("scroll",e),this.keepDisplaySw.addEventListener("change",e),window.addEventListener("keydown",t=>this.handleKeydown(t,e)),this.volumeBtn.addEventListener("click",()=>this.onVolumeClick()),window.addEventListener("scroll",()=>this.handleScroll())}handleKeydown(e,t){const s=e.key,n=document.activeElement,i=n&&n.classList.contains("chframe");switch(s){case"V":case"v":this.volumeBtn.click(),this.volumeBtn.focus();break;case"D":case"d":this.keepDisplaySw.click(),this.keepDisplaySw.focus();break;case"F":case"f":this.fullscreenBtn.click(),this.fullscreenBtn.focus();break;case"ArrowUp":case"ArrowRight":case"ArrowDown":case"ArrowLeft":this.onDirectionalKey(s);break;case"Enter":case" ":i&&n.click();break;case"R":case"r":i&&n.querySelector(".reload").dispatchEvent(new MouseEvent("click",{shiftKey:e.shiftKey}));break;case"PageUp":this.onTuning("up");break;case"PageDown":this.onTuning("down");break}if(!isNaN(parseInt(s,10))){const a=parseInt(s,10);this.onTuning(a)}t()}handleScroll(){const e=()=>{const t=window.document.body,s=window.document.documentElement,n=t.scrollTop||s.scrollTop;return s.scrollHeight-window.innerHeight-n};this.control.classList.toggle("slide",e()<=10)}onDirectionalKey(e){const t=Array.from(this.chList.querySelectorAll(".chframe")),s=document.activeElement;if(!s||!s.classList.contains("chframe")){t.find(o=>o.tabIndex===0)?.focus();return}const n=t.indexOf(s);let i=null;if(this.chList.classList.contains("choiced")){const a=t.findIndex(h=>h.classList.contains("listening"));if(a===-1)return;const o=p.CHOICED_TILE,c=o[0].length,d=o.find(h=>h.includes(n));if(!d)return;const f=t.length<=7?4:4+Math.ceil((t.length-7)/c);if(n===a)switch(e){case"ArrowUp":case"ArrowDown":i=0,i===a&&i++;break;case"ArrowRight":case"ArrowLeft":i=6,i===a&&i--;break}else{const h={x:d.findIndex(l=>l===n),y:o.indexOf(d)},g=l=>{switch(e){case"ArrowUp":l.y--;break;case"ArrowRight":l.x++;break;case"ArrowDown":l.y++;break;case"ArrowLeft":l.x--;break}return l.x=(l.x+d.length)%d.length,l.y=(l.y+f)%f,o[l.y][l.x]};i=g(h),i===-1?i=a:i===a&&(i=g(h))}}else{const o=t.length%3===0?0:3-t.length%3,c=t.length+o;switch(e){case"ArrowUp":i=(n-3+c)%c;break;case"ArrowRight":i=(n+1)%c;break;case"ArrowDown":i=(n+3)%c;break;case"ArrowLeft":i=(n-1+c)%c;break}i>=t.length&&(e==="ArrowUp"||e==="ArrowDown"?i=i%3:i=e==="ArrowRight"?0:t.length-1)}t[n].tabIndex=-1,t[i].tabIndex=0,t[i].focus()}showAndHide(){this.hideTimer&&clearTimeout(this.hideTimer),this.delayHideTimer&&clearTimeout(this.delayHideTimer),this.wrap.classList.remove("hide-ui"),this.wrap.classList.remove("hide-info"),this.hideTimer=setTimeout(()=>{this.wrap.classList.add("hide-ui"),!this.keepDisplaySw.checked&&(this.delayHideTimer=setTimeout(()=>{this.wrap.classList.add("hide-info")},3e3))},3e3)}setOnVolumeClick(e){this.onVolumeClick=e}setOnTuning(e){this.onTuning=e}}class v{channelsList;constructor(){this.channelsList=null}async updateChannels(){this.channelsList=await fetch(`${u.getApiBaseUrl()}/channels`).then(e=>(e.status!==200&&console.log("error or no content",e.status),e.json())).catch(e=>(console.error("Failed to load",e),null))}getGR(){return this.channelsList?.GR||[]}getDisplayGR(){return this.getGR().filter(e=>e.is_display===!0)}}class y{chFrames;chList;volumeBtn;constructor(e,t,s){this.chFrames=e,this.chList=t,this.volumeBtn=s}tune(e){let t=null;if(typeof e=="number"){e=e===0?10:e;const s=this.chFrames.findIndex(n=>n.ch.remocon_id===e);if(s===-1)return;t=s}else if(e==="up"||e==="down"){const s=this.chFrames.map(i=>i.video.muted);if(s.filter(i=>!i).length===1){const i=e==="up"?1:-1;t=(s.indexOf(!1)+i+this.chFrames.length)%this.chFrames.length}else t=0}else if(e==="all")t="all";else if(e==="toggle-all")this.chFrames.every(n=>n.video.muted)&&(t="all");else if(typeof e=="object"){const s=e,n=this.chFrames.indexOf(s);if(n===-1)return;s.video.muted&&(t=n)}this.applyMuteState(t)}applyMuteState(e){const t=Array(this.chFrames.length).fill(!0),s=typeof e=="number";s?t[e]=!1:e==="all"&&t.fill(!1),this.chFrames.forEach((n,i)=>{n.video.muted=t[i],n.elem.tabIndex=-1}),this.chList.classList.toggle("choiced",s),s?(this.chFrames[e].elem.tabIndex=0,this.chFrames[e].elem.focus()):(this.chFrames[0].elem.tabIndex=0,this.chFrames[0].elem.focus()),this.updateVolumeButton()}updateVolumeButton(){const e=this.chFrames.some(s=>!s.video.muted),t=this.chFrames.every(s=>!s.video.muted);e?(this.volumeBtn.innerHTML='<i class="material-icons">volume_up</i>',t?this.volumeBtn.title="ミュートする(V)":this.volumeBtn.title="全ch聴く(V)"):(this.volumeBtn.innerHTML='<i class="material-icons">volume_off</i>',this.volumeBtn.title="全ch聴く(V)")}}class b{ch;tuner;elem;video;reloadButton;broadcastTitle;title;startTime;endTime;player;constructor(e,t){this.ch=e,this.tuner=t,this.elem=null,this.video=null,this.reloadButton=null,this.broadcastTitle=null,this.title=null,this.startTime=null,this.endTime=null,this.player=null,this.createElement(),this.setupEventListeners(),this.initPlayer()}createElement(){this.elem=document.createElement("div"),this.elem.classList.add("chframe"),this.elem.tabIndex=-1,this.elem.innerHTML=`
        <video playsinline controlsList="noremoteplayback" autoplay muted></video>
        <div class="broadcast-wrap">
            <div class="broadcast-channel-box">
                <span class="broadcast-channel">${this.ch.remocon_id}</span>
                <img class="broadcast-logo" src="${u.getApiBaseUrl()}/channels/${this.ch.id}/logo" alt="${this.ch.name}">
            </div>
            <div class="broadcast-title">
                <span class="broadcast-title-id">${this.ch.program_present?.title??"(情報なし)"}</span>
                <div class="broadcast-time">
                    <span class="broadcast-start">${this.ch.program_present?this.getFormattedTime(this.ch.program_present.start_time):"--:--"}</span>
                    <span class="broadcast-to">～</span>
                    <span class="broadcast-end">${this.ch.program_present?this.getFormattedTime(this.ch.program_present.end_time):"--:--"}</span>
                </div>
            </div>
        </div>
        <div class="control">
            <button type="button" class="reload btn" title="再読み込み"><i class="material-icons">refresh</i></button>
        </div>
        `,this.video=this.elem.querySelector("video"),this.reloadButton=this.elem.querySelector(".reload"),this.broadcastTitle=this.elem.querySelector(".broadcast-title"),this.title=this.elem.querySelector(".broadcast-title-id"),this.startTime=this.elem.querySelector(".broadcast-start"),this.endTime=this.elem.querySelector(".broadcast-end")}setupEventListeners(){this.elem.addEventListener("click",()=>this.tuner.tune(this)),this.video.addEventListener("volumechange",e=>this.handleVolumeChange(e))}handleVolumeChange(e){this.elem.classList.toggle("listening",!e.target.muted)}initPlayer(){if(w.getFeatureList().mseLivePlayback){const e=`${u.getApiBaseUrl()}/streams/live/${this.ch.display_channel_id}/360p/mpegts`;this.player=w.createPlayer({type:"mse",isLive:!0,url:e}),this.player.attachMediaElement(this.video),this.reloadButton.addEventListener("click",t=>this.handleReload(t)),this.player.load()}}handleReload(e){if(e.stopPropagation(),this.player.unload(),e.shiftKey){alert("Shiftキーを押しながらクリックしたため、読み込み停止をしました。");return}this.player.load(),this.player.play()}updateProgramInfo(e){const t={title:this.title,startTime:this.startTime,endTime:this.endTime},s=Object.values(t).map(r=>r.textContent),n=[e.program_present?.title??"(情報なし)",e.program_present?this.getFormattedTime(e.program_present.start_time):"--:--",e.program_present?this.getFormattedTime(e.program_present.end_time):"--:--"];if(s.toString()!==n.toString()){const r=`
            <span class="broadcast-title-id">${e.program_present?.title??"(情報なし)"}</span>
            <div class="broadcast-time">
                <span class="broadcast-start">${e.program_present?this.getFormattedTime(e.program_present.start_time):"--:--"}</span>
                <span class="broadcast-to">～</span>
                <span class="broadcast-end">${e.program_present?this.getFormattedTime(e.program_present.end_time):"--:--"}</span>
            </div>
            `;this.broadcastTitle.innerHTML=r}}getFormattedTime(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}class L{fullscreenBtn;constructor(e){this.fullscreenBtn=e,this.init()}init(){this.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),document.addEventListener("fullscreenchange",()=>this.handleFullscreenChange())}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(e=>{alert("ご利用のブラウザは全画面表示に対応していません"+e.name)})}handleFullscreenChange(){document.fullscreenElement?(screen.orientation?.lock("landscape").catch(()=>{}),this.fullscreenBtn.innerHTML='<i class="material-icons">fullscreen_exit</i>',this.fullscreenBtn.title="全画面表示を終了(F)"):(screen.orientation?.unlock(),this.fullscreenBtn.innerHTML='<i class="material-icons">fullscreen</i>',this.fullscreenBtn.title="全画面表示(F)")}}class T{wrap;chList;control;volumeBtn;keepDisplaySw;fullscreenBtn;uiController;channelManager;chFrames;tuner;fullscreenController;constructor(){this.wrap=document.getElementById("wrap"),this.chList=document.getElementById("chlist"),this.control=document.getElementById("control"),this.volumeBtn=document.getElementById("volumebutton"),this.keepDisplaySw=document.getElementById("keepshowsw"),this.fullscreenBtn=document.getElementById("fsbutton"),this.uiController=new p(this.wrap,this.chList,this.control,this.volumeBtn,this.keepDisplaySw,this.fullscreenBtn),this.channelManager=new v,this.chFrames=[],this.tuner=new y(this.chFrames,this.chList,this.volumeBtn),this.fullscreenController=new L(this.fullscreenBtn)}async init(){await this.channelManager.updateChannels(),this.createChannelFrames(),this.uiController.setOnVolumeClick(()=>this.tuner.tune("toggle-all")),this.uiController.setOnTuning(e=>this.tuner.tune(e)),this.uiController.init(),this.startPeriodicUpdate()}createChannelFrames(){this.channelManager.getDisplayGR().forEach((e,t)=>{const s=new b(e,this.tuner);this.chFrames.push(s),t===0&&(s.elem.tabIndex=0),this.chList.appendChild(s.elem)})}startPeriodicUpdate(){setInterval(async()=>{await this.channelManager.updateChannels(),this.channelManager.getDisplayGR().forEach((e,t)=>{this.chFrames[t]&&this.chFrames[t].updateProgramInfo(e)})},30*1e3)}}const F=new T;F.init();
