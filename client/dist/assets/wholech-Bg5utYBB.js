import{aD as r}from"./SnackbarsStore-BWrzfOQC.js";import{m as o}from"./mpegts-DuuhU9Ut.js";class c{wrap;control;volumeBtn;keepDisplaySw;fullscreenBtn;hideTimer;delayHideTimer;onVolumeClick;onTuning;constructor(e,t,s,i,n){this.wrap=e,this.control=t,this.volumeBtn=s,this.keepDisplaySw=i,this.fullscreenBtn=n,this.hideTimer=null,this.delayHideTimer=null,this.onVolumeClick=()=>{},this.onTuning=()=>{}}init(){this.setupEventListeners(),this.showAndHide()}setupEventListeners(){const e=()=>this.showAndHide();window.addEventListener("pointerdown",e),window.addEventListener("pointermove",e),window.addEventListener("scroll",e),this.keepDisplaySw.addEventListener("change",e),window.addEventListener("keydown",t=>this.handleKeydown(t,e)),this.volumeBtn.addEventListener("click",()=>this.onVolumeClick()),window.addEventListener("scroll",()=>this.handleScroll())}handleKeydown(e,t){const s=e.key;switch(s){case"V":case"v":this.volumeBtn.click();break;case"D":case"d":this.keepDisplaySw.click();break;case"F":case"f":this.fullscreenBtn.click();break;case"ArrowUp":case"ArrowRight":this.onTuning("up");break;case"ArrowDown":case"ArrowLeft":this.onTuning("down");break}if(!isNaN(parseInt(s,10))){const n=parseInt(s,10);this.onTuning(n)}t()}handleScroll(){const e=()=>{const t=window.document.body,s=window.document.documentElement,i=t.scrollTop||s.scrollTop;return s.scrollHeight-window.innerHeight-i};this.control.classList.toggle("slide",e()<=10)}showAndHide(){this.hideTimer&&clearTimeout(this.hideTimer),this.delayHideTimer&&clearTimeout(this.delayHideTimer),this.wrap.classList.remove("hide-ui"),this.wrap.classList.remove("hide-info"),this.hideTimer=setTimeout(()=>{this.wrap.classList.add("hide-ui"),!this.keepDisplaySw.checked&&(this.delayHideTimer=setTimeout(()=>{this.wrap.classList.add("hide-info")},3e3))},3e3)}setOnVolumeClick(e){this.onVolumeClick=e}setOnTuning(e){this.onTuning=e}}class h{channelsList;constructor(){this.channelsList=null}async updateChannels(){this.channelsList=await fetch(`${r.getApiBaseUrl()}/channels`).then(e=>(e.status!==200&&console.log("error or no content",e.status),e.json())).catch(e=>(console.error("Failed to load",e),null))}getGR(){return this.channelsList?.GR||[]}getDisplayGR(){return this.getGR().filter(e=>e.is_display===!0)}}class d{chFrames;chList;volumeBtn;constructor(e,t,s){this.chFrames=e,this.chList=t,this.volumeBtn=s}tune(e){let t=null;if(typeof e=="number"){e=e===0?10:e;const s=this.chFrames.findIndex(i=>i.ch.remocon_id===e);if(s===-1)return;t=s}else if(e==="up"||e==="down"){const s=this.chFrames.map(n=>n.video.muted);if(s.filter(n=>!n).length===1){const n=e==="up"?1:-1;t=(s.indexOf(!1)+n+this.chFrames.length)%this.chFrames.length}else t=0}else if(e==="all")t="all";else if(e==="toggle-all")this.chFrames.every(i=>i.video.muted)&&(t="all");else if(typeof e=="object"){const s=e,i=this.chFrames.indexOf(s);if(i===-1)return;t=i}this.applyMuteState(t)}applyMuteState(e){const t=Array(this.chFrames.length).fill(!0);e==="all"?t.fill(!1):typeof e=="number"&&(t[e]=!1),this.chFrames.forEach((i,n)=>{i.video.muted=t[n]});const s=t.filter(i=>!i).length===1;this.chList.classList.toggle("choiced",s),this.updateVolumeButton()}updateVolumeButton(){const e=this.chFrames.some(s=>!s.video.muted),t=this.chFrames.every(s=>!s.video.muted);e?(this.volumeBtn.innerHTML='<i class="material-icons">volume_up</i>',t?this.volumeBtn.title="ミュートする(V)":this.volumeBtn.title="全ch聴く(V)"):(this.volumeBtn.innerHTML='<i class="material-icons">volume_off</i>',this.volumeBtn.title="全ch聴く(V)")}}class m{ch;tuner;elem;video;reloadButton;broadcastTitle;title;startTime;endTime;player;constructor(e,t){this.ch=e,this.tuner=t,this.elem=null,this.video=null,this.reloadButton=null,this.broadcastTitle=null,this.title=null,this.startTime=null,this.endTime=null,this.player=null,this.createElement(),this.setupEventListeners(),this.initPlayer()}createElement(){this.elem=document.createElement("div"),this.elem.classList.add("chframe"),this.elem.innerHTML=`
        <video playsinline controlsList="noremoteplayback" autoplay muted></video>
        <div class="broadcast-wrap">
            <div class="broadcast-channel-box">
                <span class="broadcast-channel">${this.ch.remocon_id}</span>
                <img class="broadcast-logo" src="${r.getApiBaseUrl()}/channels/${this.ch.id}/logo" alt="${this.ch.name}">
            </div>
            <div class="broadcast-title">
                <span class="broadcast-title-id">${this.ch.program_present?.title??"(情報なし)"}</span>
                <div class="broadcast-time">
                    <span class="broadcast-start">${this.ch.program_present?this.getFormattedTime(this.ch.program_present.start_time):"--:--"}</span>
                    <span class="broadcast-to">～</span>
                    <span class="broadcast-end">${this.ch.program_present?this.getFormattedTime(this.ch.program_present.end_time):"--:--"}</span>
                </div>
            </div>
        </div>
        <div class="control">
            <button type="button" class="reload btn" title="再読み込み"><i class="material-icons">refresh</i></button>
        </div>
        `,this.video=this.elem.querySelector("video"),this.reloadButton=this.elem.querySelector(".reload"),this.broadcastTitle=this.elem.querySelector(".broadcast-title"),this.title=this.elem.querySelector(".broadcast-title-id"),this.startTime=this.elem.querySelector(".broadcast-start"),this.endTime=this.elem.querySelector(".broadcast-end")}setupEventListeners(){this.elem.addEventListener("click",()=>this.tuner.tune(this)),this.video.addEventListener("volumechange",e=>this.handleVolumeChange(e))}handleVolumeChange(e){this.elem.classList.toggle("listening",!e.target.muted)}initPlayer(){if(o.getFeatureList().mseLivePlayback){const e=`${r.getApiBaseUrl()}/streams/live/${this.ch.display_channel_id}/360p/mpegts`;this.player=o.createPlayer({type:"mse",isLive:!0,url:e}),this.player.attachMediaElement(this.video),this.reloadButton.addEventListener("click",t=>this.handleReload(t)),this.player.load()}}handleReload(e){if(e.stopPropagation(),this.player.unload(),e.shiftKey){alert("Shiftキーを押しながらクリックしたため、読み込み停止をしました。");return}this.player.load(),this.player.play()}updateProgramInfo(e){const t={title:this.title,startTime:this.startTime,endTime:this.endTime},s=Object.values(t).map(a=>a.textContent),i=[e.program_present?.title??"(情報なし)",e.program_present?this.getFormattedTime(e.program_present.start_time):"--:--",e.program_present?this.getFormattedTime(e.program_present.end_time):"--:--"];if(s.toString()!==i.toString()){const a=`
            <span class="broadcast-title-id">${e.program_present?.title??"(情報なし)"}</span>
            <div class="broadcast-time">
                <span class="broadcast-start">${e.program_present?this.getFormattedTime(e.program_present.start_time):"--:--"}</span>
                <span class="broadcast-to">～</span>
                <span class="broadcast-end">${e.program_present?this.getFormattedTime(e.program_present.end_time):"--:--"}</span>
            </div>
            `;this.broadcastTitle.innerHTML=a}}getFormattedTime(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}class u{fullscreenBtn;constructor(e){this.fullscreenBtn=e,this.init()}init(){this.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),document.addEventListener("fullscreenchange",()=>this.handleFullscreenChange())}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(e=>{alert("ご利用のブラウザは全画面表示に対応していません"+e.name)})}handleFullscreenChange(){document.fullscreenElement?(screen.orientation?.lock("landscape").catch(()=>{}),this.fullscreenBtn.innerHTML='<i class="material-icons">fullscreen_exit</i>',this.fullscreenBtn.title="全画面表示を終了(F)"):(screen.orientation?.unlock(),this.fullscreenBtn.innerHTML='<i class="material-icons">fullscreen</i>',this.fullscreenBtn.title="全画面表示(F)")}}class p{wrap;chList;control;volumeBtn;keepDisplaySw;fullscreenBtn;uiController;channelManager;chFrames;tuner;fullscreenController;constructor(){this.wrap=document.getElementById("wrap"),this.chList=document.getElementById("chlist"),this.control=document.getElementById("control"),this.volumeBtn=document.getElementById("volumebutton"),this.keepDisplaySw=document.getElementById("keepshowsw"),this.fullscreenBtn=document.getElementById("fsbutton"),this.uiController=new c(this.wrap,this.control,this.volumeBtn,this.keepDisplaySw,this.fullscreenBtn),this.channelManager=new h,this.chFrames=[],this.tuner=null,this.fullscreenController=new u(this.fullscreenBtn)}async init(){await this.channelManager.updateChannels(),this.createChannelFrames(),this.tuner=new d(this.chFrames,this.chList,this.volumeBtn),this.uiController.setOnVolumeClick(()=>this.tuner.tune("toggle-all")),this.uiController.setOnTuning(e=>this.tuner.tune(e)),this.uiController.init(),this.startPeriodicUpdate()}createChannelFrames(){this.channelManager.getDisplayGR().forEach(e=>{const t=new m(e,this.tuner);this.chFrames.push(t),this.chList.appendChild(t.elem)})}startPeriodicUpdate(){setInterval(async()=>{await this.channelManager.updateChannels(),this.channelManager.getDisplayGR().forEach((e,t)=>{this.chFrames[t]&&this.chFrames[t].updateProgramInfo(e)})},30*1e3)}}const g=new p;g.init();
